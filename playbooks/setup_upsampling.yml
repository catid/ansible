---
- name: Set up upsampling environment
  hosts: all
  become: no
  vars_files:
    - sudo.yml
  tasks:
    - name: Install ffmpeg
      become: yes
      ansible.builtin.apt:
        name: ffmpeg
        state: present

    - name: Install gcc-11
      become: yes
      ansible.builtin.apt:
        name: gcc-11
        state: present

    - name: Install g++-11
      become: yes
      ansible.builtin.apt:
        name: g++-11
        state: present

    - name: Install OpenMPI library
      become: yes
      ansible.builtin.apt:
        name: libopenmpi-dev
        state: present

    - name: Check if upsampling repository exists
      ansible.builtin.stat:
        path: "{{ lookup('env', 'HOME') }}/sources/upsampling"
      register: upsampling_repository

    - name: Add github.com to known_hosts
      ansible.builtin.known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan github.com') }}"
        state: present
        path: "{{ lookup('env', 'HOME') }}/.ssh/known_hosts"

    - name: Clone upsampling repository
      ansible.builtin.git:
        repo: git@github.com:catid/upsampling
        dest: "{{ lookup('env', 'HOME') }}/sources/upsampling"
        update: "{{ upsampling_repository.stat.exists }}"

    - name: Check if upsampling conda environment exists
      ansible.builtin.shell:
        cmd: "{{ lookup('env', 'HOME') }}/miniconda3/bin/conda env list | grep upsampling"
      register: conda_env_output
      ignore_errors: true

    - name: Create upsampling conda environment and install dependencies
      block:
        - name: Create conda environment
          ansible.builtin.shell:
            cmd: "{{ lookup('env', 'HOME') }}/miniconda3/bin/conda create -y --name upsampling python=3.8"
      when: conda_env_output.rc != 0

    - name: Install PyTorch, torchvision, and functorch
      ansible.builtin.shell:
        cmd: "{{ lookup('env', 'HOME') }}/miniconda3/envs/upsampling/bin/pip install torch torchvision functorch --extra-index-url https://download.pytorch.org/whl/cu118"

    - name: Install NVIDIA DALI
      ansible.builtin.shell:
        cmd: "{{ lookup('env', 'HOME') }}/miniconda3/envs/upsampling/bin/pip install --extra-index-url https://developer.download.nvidia.com/compute/redist --upgrade nvidia-dali-cuda110"

    - name: Install pip requirements.txt
      shell: |
        cd "{{ lookup('env', 'HOME') }}/sources/upsampling"
        "{{ lookup('env', 'HOME') }}/miniconda3/envs/upsampling/bin/pip" install -r requirements.txt
